<% 	--[[=========== STYLES ==========]] %>
<%+ts_skw92a/css%>

<% --[[=========== JS ==========]] %>
<%+ts_skw92a/ui_utils/utils.js%>
<%+ts_skw92a/ui_utils/external.js%>
<%+ts_skw92a/ui_utils/websocket.js%>
<%+ts_skw92a/ui_overrides/TextFieldStyled.js%>
<%+ts_skw92a/sim.js%>
<%+ts_skw92a/sim_modal%>
<%+ts_skw92a/modal_switch_sim%>


<% --[[=========== UI WIDGETS ==========]] %>
<%+ts_skw92a/ui_widgets/UIEventBus.js%>
<%+ts_skw92a/ui_widgets/UITextareaHighlighted.js%>

<% --[[=========== LUA BACKEND ==========]] %>

<%
	local config = "tsmodem"
	local uci = require "luci.model.uci".cursor()
	local util = require "luci.util"


	local sims_config = {} 	-- got from UCI config
	local sims_state = {}	-- got from realtime data
	sims_state = {
		["0"] = {
			balance = 29.30,
			balance_date = "15.05.2021",
			rssi = 21,
			bor = 0
		},
		["1"] = {
			balance = 280.55,
			balance_date = "15.05.2021",
			rssi = 28,
			bor = 1
		}

	}
	--util.dumptable(sims_state)
	uci:foreach(config, "sim", function(a)
		sims_config[#sims_config+1] = a
	end)
	util.dumptable(sims_config)
	local i = 1
	local function animationWrapper(str, is_active)
		local html = ''
		str = "" .. str
		if is_active then
			for c=1, #str do
				html = html .. string.format('<span class="anime">%s</span>', str:sub(c,c))
			end
		else html = str end
		return html
	end
%> 

<% --[[=========== HTML ==========]] %>
<div id="view">
	<h2 name="content">Мобильное устройство дистанционного управления</h2>
	<div class="cbi-map-descr">Связь с мобильным устройством поддерживается основным и резервным каналом.</div>
	<h3>Каналы связи (настройка SIM-карт)</h3>
	
	<div class="table">
		<div class="tr table-titles">
			<div class="th">N</div>
			<div class="th">Наименование</div>
			<div class="th" style="width: 33%;">Статус</div>
			<div class="th">Сигнал</div>
			<div class="th">Помехи</div>
			<div class="th">Баланс</div>
			<div class="th center nowrap cbi-section-actions">Действия</div>
		</div>
		<% for k, v in util.kspairs(sims_config) do
			local index = tostring(v[".index"])
			local simid = v[".name"]:sub(5,5)
			local is_active = (v.status == '1')
			local balance = tostring(sims_state[index].balance)
			local balance_date = sims_state[index].balance_date
			local highlighted_balance = (sims_state[index].balance < tonumber(v.balance_min))
			local bor = sims_state[index].bor
			if bor == 0 then bor =  "&#8211;" end
		%>
			<div id="simid-<%=simid %>" class="tr cbi-rowstyle-<%=i%>">
				<div class="td" data-title="N">
					<%=v[".index"] + 1 %>
				</div>
				<div class="td" data-title="Наименование" style="white-space: nowrap;">
					<%=v.name %>
				</div>
				<div class="td network_registration" style="width: 170px;" data-title="Статус">
					<%
						if is_active then print('<i style="background-position: 0 -60px;">Неизвестно</i>')
						else print('<i>Не активна</i>')	end 
					%>
				</div>
				<div class="td signal" data-title="Сигнал">
					<%=sims_state[index].rssi %> <%= v.rssi_unit %>
				</div>
				<div class="td error" data-title="Помехи">
					<%= bor %>
				</div>
				<div class="td <% if highlighted_balance then print('balance-alert') end %>" data-title="Баланс" style="white-space: nowrap;">
					<span class="balance"><%= animationWrapper(balance, is_active) %></span> <%= v.balance_unit %><br />
					<small>(на <%=balance_date %>)</small>
				</div>
				<div class="nowrap cbi-section-actions td" style="text-align: right;">
					<input type="button" class="cbi-button cbi-button-apply sim-<%=simid %>"
						onclick="switch_sim(this)"
						data-simid="<%=simid %>"
						value="Активировать"
						disabled="disabled"
						<%
							-- if is_active then print('disabled="disabled"') end 
						%>
						style="display: initial;" />
					<input type="button" class="cbi-button cbi-button-apply"
						onclick="edit_sim(this)"
						data-simid="<%=simid %>"
						value="Настроить"
						style="display: initial;" />
				</div>
			</div>
			<% i = (i%2) + 1 %>
		<% end %>
	</div>
</div>

<h3>Журнал событий</h3>
<div class="table journal">
	<div class="tr table-titles">
		<div class="th" style="width: 150px;">Дата / время</div>
		<div class="th" style="width: 33%;">Событие</div>
		<div class="th">Источник</div>
		<div class="th">Команда</div>
		<div class="th" style="padding-left: 25px;">Ответ</div>
	</div>
</div>
<span id="btn_enable_spinner" class="btn_spinner"></span>



