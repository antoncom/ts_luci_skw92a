<% 	--[[=========== STYLES ==========]] %>
<%+ts_skw92a/css%>

<% --[[=========== JS ==========]] %>
<%+ts_skw92a/ui_utils/utils.js%>
<%+ts_skw92a/ui_utils/external.js%>
<%+ts_skw92a/ui_overrides/TextFieldStyled.js%>


<% --[[=========== UI WIDGETS ==========]] %>
<%+ts_skw92a/ui_widgets/UIEventBus.js%>

<% --[[=========== LUA BACKEND ==========]] %>

<%
	local config = "ts_skw92a"
	local uci = require "luci.model.uci".cursor()
	local util = require "luci.util"


	local sims_config = {} 	-- got from UCI config
	local sims_state = {}	-- got from realtime data
	sims_state = {
		["0"] = {
			balance = 29.30,
			balance_date = "15.05.2021",
			rssi = 21,
			bor = 0
		},
		["1"] = {
			balance = 280.55,
			balance_date = "15.05.2021",
			rssi = 28,
			bor = 1
		}

	}
	util.dumptable(sims_state)
	uci:foreach(config, "sim", function(a)
		sims_config[#sims_config+1] = a
	end)
	--util.dumptable(sims_config)
	local i = 1
%> 

<% --[[=========== HTML ==========]] %>
<div id="view">
	<h2 name="content">Мобильное устройство дистанционного управления</h2>
	<div class="cbi-map-descr">Связь с мобильным устройством поддерживается основным и резервным каналом.</div>
	<h3>Каналы связи (настройка SIM-карт)</h3>
	
	<div class="table">
		<div class="tr table-titles">
			<div class="th">N</div>
			<div class="th" style="width: 33%;">Наименование</div>
			<div class="th">Статус</div>
			<div class="th">Сигнал</div>
			<div class="th">Помехи</div>
			<div class="th">Баланс</div>
			<div class="th center nowrap cbi-section-actions">Действия</div>
		</div>
		<% for k, v in util.kspairs(sims_config) do
			local index = tostring(v[".index"])
			local is_active = (v.status == '1')
			local balance = tostring(sims_state[index].balance) .. " " .. v.min_account_balance_unit
			local balance_date = sims_state[index].balance_date
			local highlighted_balance = (sims_state[index].balance < tonumber(v.min_account_balance))
			local bor = sims_state[index].bor
			if bor == 0 then bor =  "&#8211;" end
		%>
			<div class="tr cbi-rowstyle-<%=i%>">
				<div class="td" data-title="N">
					<%=v[".index"] + 1 %>
				</div>
				<div class="td" data-title="Наименование">
					<%=v.name %>
				</div>
				<div class="td status" data-title="Статус">
					<%
						if is_active then print('<i style="background-position: 0 -15px;">Активно</i>')
						else print('<i>Не активно</i>')	end 
					%>
				</div>
				<div class="td" data-title="Сигнал">
					<%=sims_state[index].rssi %> <%=v.min_signal_strength_unit %>
				</div>
				<div class="td" data-title="Помехи">
					<%=bor %>
				</div>
				<div class="td <% if highlighted_balance then print('balance-alert') end %>" data-title="Баланс">
					<b><%=balance %></b> <br />
					<small>(на <%=balance_date %>)</small>
				</div>
				<div class="nowrap cbi-section-actions td" style="text-align: right;">
					<input type="button" class="cbi-button cbi-button-apply"
						onclick="activate_sim(this)"
						value="Активировать"
						<%
							if is_active then print('disabled="disabled"') end 
						%>
						style="display: initial;" />
					<input type="button" class="cbi-button cbi-button-apply"
						onclick="edit_sim(this)"
						data-alertid="<%=k%>"
						value="Настроить"
						style="display: initial;" />
				</div>
			</div>
			<% i = (i%2) + 1 %>
		<% end %>
	</div>
</div>

<h3>Журнал событий</h3>
<div class="table">
	<div class="tr table-titles">
		<div class="th" style="width: 150px;">Дата / время</div>
		<div class="th" style="width: 33%;">Событие</div>
		<div class="th">Источник</div>
		<div class="th">Команда</div>
		<div class="th" style="padding-left: 25px;">Ответ</div>

	</div>
	<div class="tr cbi-rowstyle-0">
		<div class="td" data-title="Дата / время">
			<b>2021-05-01</b><i>13:35:10</i>
		</div>
		<div class="td" data-title="Событие">
			Сеть недоступна
		</div>
		<div class="td" data-title="Источник">
			Модем
		</div>
		<div class="td" data-title="Команда">
			AT+CREG=?
		</div>
		<div class="td" data-title="Ответ">
			NOT READY
		</div>
	</div>

	<div class="tr cbi-rowstyle-0">
		<div class="td" data-title="Дата / время">
			<b>2021-05-01</b><i>13:35:10</i>
		</div>
		<div class="td" data-title="Событие">
			Переключение SIM-карт
		</div>
		<div class="td" data-title="Источник">
			Микроконтроллер
		</div>
		<div class="td" data-title="Команда">
			~0:SIM.SEL=1
		</div>
		<div class="td" data-title="Ответ">
			OK
		</div>
	</div>

	<div class="tr cbi-rowstyle-0">
		<div class="td" data-title="Дата / время">
			<b>2021-05-01</b><i>13:35:10</i>
		</div>
		<div class="td" data-title="Событие">
			Связь установлена
		</div>
		<div class="td" data-title="Источник">
			Модем
		</div>
		<div class="td" data-title="Команда">
			AT+CSQ
		</div>
		<div class="td" data-title="Ответ">
			22,99 (rssi, bor)
		</div>
	</div>

	<div class="tr cbi-rowstyle-0">
		<div class="td" data-title="Дата / время">
			<b>2021-05-01</b><i>13:35:10</i>
		</div>
		<div class="td" data-title="Событие">
			Остаток средств ниже нормы
		</div>
		<div class="td" data-title="Источник">
			Модем
		</div>
		<div class="td" data-title="Команда">
			AT+CUSD=*101#,15
		</div>
		<div class="td" data-title="Ответ">
			29,85 (руб)
		</div>
	</div>

	<div class="tr cbi-rowstyle-0">
		<div class="td" data-title="Дата / время">
			<b>2021-05-01</b><i>13:35:10</i>
		</div>
		<div class="td" data-title="Событие">
			Переключение SIM-карт
		</div>
		<div class="td" data-title="Источник">
			Пользователь
		</div>
		<div class="td" data-title="Команда">
			~0:SIM.SEL=0
		</div>
		<div class="td" data-title="Ответ">
			OK
		</div>
	</div>
</div>
<span id="btn_enable_spinner" class="btn_spinner"></span>



